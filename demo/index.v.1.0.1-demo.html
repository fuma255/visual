<html>

<head>
    <title>Demo of visual</title>
    <style>
        #content {
            margin-top: 60px;
        }
    </style>
    <script src="libs/jquery.min.js"></script>
    <script src="http://api.map.baidu.com/api?v=2.0&ak=3ikdHZXr6mIXgWOa7VENbdUI"></script>
    <script src="../dist/visual.1.0.1.js"></script>
    <script src="libs/stats.min.js"></script>
</head>

<body>
    <div id="content" style="width:300px; height: 300px; border:1px solid #ccc;"></div>
    <div>
        <input type="text" id="input">
        <button id="canvas2textarea">向右</button>
        <button id="textarea2canvas">向左</button>
        <button id="save">保存</button>
        <button id="release">发布</button>
        <button id="preview">预览</button>
        <br/>
        <button id="draw-box">重画边界</button>
        <br>
        <form id="preview-form" target="iframe" method="post">
            <input type="hidden" name="alwaysImage" value="1"/>
            <input type="hidden" name="configData" value="{}"/>
        </form>
        <div id="map-point"></div>
        <iframe id="iframe" name="iframe" width="400px" height="200px;"></iframe>
        <img id="preview-image"/>

        <br/>
        <button id="select-start">选起点</button> <input type="text" value="116.409671,39.911693"/><br/>
        <button id="select-end">选终点</button> <input type="text" value="116.41312,39.925638"/><br/>
        <button id="draw-road">画路</button><button id="add-road">添加到JSON</button>
        <div style="position:absolute; bottom: 0; top:50%; left:550px; right:0;;background:red;" id="map"></div>
        
        <div style="position:absolute; top: 0; right:0; bottom:50%; left: 550px">
            <textarea style="width:100%;height:100%;" id="textarea"></textarea>
            <input type="text" id="keyword" style="position:absolute; bottom: -30px; right:0"/>
        </div>
    </div>
    <script>
        let locparms = location.search.slice(1).split('&');
        let param = {}
        locparms.forEach(item => {
            let pa = item.split('=');
            param[pa[0]] = pa[1];
        });
        let api = window.api = param.api;
        let dom = document.getElementById('content');
        let v = new Visual(dom);

        let input = document.getElementById('input');
        input.onchange = (e) => {
            
            $.ajax({
                url: api + '/guidingscreen/screen/detail?id=' + e.target.value,
                dataType: 'JSONP',
                success: (data) => {
                    window.detail = data.data.detail;
                    window.config = JSON.parse(detail.configData);
                    
                    dom.innerHTML = '';
                    dom.style.height = `${config.global.height}px`;
                    dom.style.width = `${config.global.width}px`;
                    v = new Visual(dom);
                    config.components.forEach((item, index) => {
                        if (item.type === 'Road') {
                            item.path.steps.forEach(step => {
                                v.line(step.pixels, {
                                    strokeStyle: '#4df693',
                                    lineWidth: 8
                                });
                            })
                        }
                    });

                    
                    drawBox();
                    $('#canvas2textarea').click();
                }
            })
        }

        let canvas2textarea = document.getElementById('canvas2textarea');
        canvas2textarea.onclick = () => {
            let globalindex = 0;
            config.components.forEach((item, index) => {
                if (item.type === 'Road') {
                    item.path.steps.forEach(step => {
                        step.pixels = v.sys.objects[globalindex].path;
                        globalindex++;
                    })
                }
            })
            document.getElementById('textarea').value = JSON.stringify(config, null, 4);
        }

        let textarea2canvas = document.getElementById('textarea2canvas');
        textarea2canvas.onclick = () => {
            config = JSON.parse(document.getElementById('textarea').value);
            dom.innerHTML = '';
            dom.style.height = `${config.global.height}px`;
            dom.style.width = `${config.global.width}px`;
            v = new Visual(dom);
            config.components.forEach((item, index) => {
                if (item.type === 'Road') {
                    item.path.steps.forEach(step => {
                        v.line(step.pixels, {
                            strokeStyle: '#4df693',
                            lineWidth: 8
                        });
                    })
                }
            })
        }

        let save = document.getElementById('save');
        save.onclick = () => {
            // let globalindex = 0;
            // config.components.forEach((item, index) => {
            //     if (item.type === 'Road') {
            //         item.path.steps.forEach(step => {
            //             step.pixels = v.sys.objects[globalindex].path;
            //             globalindex++;
            //         })
            //     }
            // })
            // console.log(config.components[0].path.steps[0].pixels[0])
            detail.configData = JSON.stringify(config);
            $.ajax({
                url: api + '/guidingscreen/screen/update',
                data: detail,
                dataType: 'JSONP',
                // type: 'POST',
                success: function() {
                    alert('success')
                }
            })
        }
    </script>
    <script>
        // let dom = document.getElementById('content');
        // let v = new Visual(dom);

        // v.line([
        //     [85, 86],
        //     [85, 89],
        //     [85, 104]
        // ], {
        //     strokeStyle: '#4df693',
        //     lineWidth: 20
        // });

        // v.line([
        //     [139, 85],
        //     [197, 85],
        //     [224, 85]
        // ], {
        //     strokeStyle: '#4df693',
        //     lineWidth: 20
        // });

        // let last = v.line([
        //     [10, 10],
        //     [400, 10],
        // ], {
        //     strokeStyle: '#4df693',
        //     lineWidth: 10
        // });

        // last.remove();

        // // v.text('hello', [200, 200]);

        // console.log(v);
    </script>


    <script>
        var stats = new Stats();
        document.body.appendChild(stats.dom);
        requestAnimationFrame(function loop() {
            stats.update();
            requestAnimationFrame(loop)
        });
</script>
<script src="./js/index.v.1.0.1-demo/index.js"></script>
</body>

</html>